{"ast":null,"code":"import SeriesBinder from '../series-binder';\nimport { OBJECT } from '../../common/constants';\nimport { Class, defined, getter, isArray, isNumber } from '../../common';\nvar STD_ERR = \"stderr\";\nvar STD_DEV = \"stddev\";\nvar percentRegex = /percent(?:\\w*)\\((\\d+)\\)/;\nvar standardDeviationRegex = new RegExp(\"^\" + STD_DEV + \"(?:\\\\((\\\\d+(?:\\\\.\\\\d+)?)\\\\))?$\");\n\nvar ErrorRangeCalculator = function (Class) {\n  function ErrorRangeCalculator(errorValue, series, field) {\n    Class.call(this);\n    this.initGlobalRanges(errorValue, series, field);\n  }\n\n  if (Class) ErrorRangeCalculator.__proto__ = Class;\n  ErrorRangeCalculator.prototype = Object.create(Class && Class.prototype);\n  ErrorRangeCalculator.prototype.constructor = ErrorRangeCalculator;\n\n  ErrorRangeCalculator.prototype.initGlobalRanges = function initGlobalRanges(errorValue, series, field) {\n    var data = series.data;\n    var deviationMatch = standardDeviationRegex.exec(errorValue);\n\n    if (deviationMatch) {\n      this.valueGetter = this.createValueGetter(series, field);\n      var average = this.getAverage(data);\n      var deviation = this.getStandardDeviation(data, average, false);\n      var multiple = deviationMatch[1] ? parseFloat(deviationMatch[1]) : 1;\n      var errorRange = {\n        low: average.value - deviation * multiple,\n        high: average.value + deviation * multiple\n      };\n\n      this.globalRange = function () {\n        return errorRange;\n      };\n    } else if (errorValue.indexOf && errorValue.indexOf(STD_ERR) >= 0) {\n      this.valueGetter = this.createValueGetter(series, field);\n      var standardError = this.getStandardError(data, this.getAverage(data));\n\n      this.globalRange = function (value) {\n        return {\n          low: value - standardError,\n          high: value + standardError\n        };\n      };\n    }\n  };\n\n  ErrorRangeCalculator.prototype.createValueGetter = function createValueGetter(series, field) {\n    var data = series.data;\n    var binder = SeriesBinder.current;\n    var valueFields = binder.valueFields(series);\n    var item = defined(data[0]) ? data[0] : {};\n    var valueGetter;\n\n    if (isArray(item)) {\n      var index = field ? valueFields.indexOf(field) : 0;\n      valueGetter = getter(\"[\" + index + \"]\");\n    } else if (isNumber(item)) {\n      valueGetter = getter();\n    } else if (typeof item === OBJECT) {\n      var srcValueFields = binder.sourceFields(series, valueFields);\n      valueGetter = getter(srcValueFields[valueFields.indexOf(field)]);\n    }\n\n    return valueGetter;\n  };\n\n  ErrorRangeCalculator.prototype.getErrorRange = function getErrorRange(pointValue, errorValue) {\n    var low, high, value;\n\n    if (!defined(errorValue)) {\n      return null;\n    }\n\n    if (this.globalRange) {\n      return this.globalRange(pointValue);\n    }\n\n    if (isArray(errorValue)) {\n      low = pointValue - errorValue[0];\n      high = pointValue + errorValue[1];\n    } else if (isNumber(value = parseFloat(errorValue))) {\n      low = pointValue - value;\n      high = pointValue + value;\n    } else if (value = percentRegex.exec(errorValue)) {\n      var percentValue = pointValue * (parseFloat(value[1]) / 100);\n      low = pointValue - Math.abs(percentValue);\n      high = pointValue + Math.abs(percentValue);\n    } else {\n      throw new Error(\"Invalid ErrorBar value: \" + errorValue);\n    }\n\n    return {\n      low: low,\n      high: high\n    };\n  };\n\n  ErrorRangeCalculator.prototype.getStandardError = function getStandardError(data, average) {\n    return this.getStandardDeviation(data, average, true) / Math.sqrt(average.count);\n  };\n\n  ErrorRangeCalculator.prototype.getStandardDeviation = function getStandardDeviation(data, average, isSample) {\n    var this$1 = this;\n    var length = data.length;\n    var total = isSample ? average.count - 1 : average.count;\n    var squareDifferenceSum = 0;\n\n    for (var idx = 0; idx < length; idx++) {\n      var value = this$1.valueGetter(data[idx]);\n\n      if (isNumber(value)) {\n        squareDifferenceSum += Math.pow(value - average.value, 2);\n      }\n    }\n\n    return Math.sqrt(squareDifferenceSum / total);\n  };\n\n  ErrorRangeCalculator.prototype.getAverage = function getAverage(data) {\n    var this$1 = this;\n    var length = data.length;\n    var sum = 0;\n    var count = 0;\n\n    for (var idx = 0; idx < length; idx++) {\n      var value = this$1.valueGetter(data[idx]);\n\n      if (isNumber(value)) {\n        sum += value;\n        count++;\n      }\n    }\n\n    return {\n      value: sum / count,\n      count: count\n    };\n  };\n\n  return ErrorRangeCalculator;\n}(Class);\n\nexport default ErrorRangeCalculator;","map":null,"metadata":{},"sourceType":"module"}