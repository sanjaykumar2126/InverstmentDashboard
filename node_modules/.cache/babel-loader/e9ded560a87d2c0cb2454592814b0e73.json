{"ast":null,"code":"import { ChartElement, Box } from '../../core';\nimport ClipAnimationMixin from '../mixins/clip-animation-mixin';\nimport ErrorRangeCalculator from '../error-bars/error-range-calculator';\nimport ScatterErrorBar from '../error-bars/scatter-error-bar';\nimport LinePoint from '../line-chart/line-point';\nimport CategoricalChart from '../categorical-chart';\nimport hasValue from '../utils/has-value';\nimport evalOptions from '../utils/eval-options';\nimport { deepExtend, isNumber, isString, defined, isFunction, setDefaultOptions } from '../../common';\nimport { X, Y, MIN_VALUE, MAX_VALUE } from '../../common/constants';\nimport { parseDate } from '../../date-utils';\n\nvar ScatterChart = function (ChartElement) {\n  function ScatterChart(plotArea, options) {\n    ChartElement.call(this, options);\n    this.plotArea = plotArea;\n    this.chartService = plotArea.chartService;\n\n    this._initFields();\n\n    this.render();\n  }\n\n  if (ChartElement) ScatterChart.__proto__ = ChartElement;\n  ScatterChart.prototype = Object.create(ChartElement && ChartElement.prototype);\n  ScatterChart.prototype.constructor = ScatterChart;\n\n  ScatterChart.prototype._initFields = function _initFields() {\n    // X and Y axis ranges grouped by name, e.g.:\n    // primary: { min: 0, max: 1 }\n    this.xAxisRanges = {};\n    this.yAxisRanges = {};\n    this.points = [];\n    this.seriesPoints = [];\n    this.seriesOptions = [];\n    this._evalSeries = [];\n  };\n\n  ScatterChart.prototype.render = function render() {\n    this.traverseDataPoints(this.addValue.bind(this));\n  };\n\n  ScatterChart.prototype.addErrorBar = function addErrorBar(point, field, fields) {\n    var value = point.value[field];\n    var valueErrorField = field + \"Value\";\n    var lowField = field + \"ErrorLow\";\n    var highField = field + \"ErrorHigh\";\n    var seriesIx = fields.seriesIx;\n    var series = fields.series;\n    var errorBars = point.options.errorBars;\n    var lowValue = fields[lowField];\n    var highValue = fields[highField];\n\n    if (isNumber(value)) {\n      var errorRange;\n\n      if (isNumber(lowValue) && isNumber(highValue)) {\n        errorRange = {\n          low: lowValue,\n          high: highValue\n        };\n      }\n\n      if (errorBars && defined(errorBars[valueErrorField])) {\n        this.seriesErrorRanges = this.seriesErrorRanges || {\n          x: [],\n          y: []\n        };\n        this.seriesErrorRanges[field][seriesIx] = this.seriesErrorRanges[field][seriesIx] || new ErrorRangeCalculator(errorBars[valueErrorField], series, field);\n        errorRange = this.seriesErrorRanges[field][seriesIx].getErrorRange(value, errorBars[valueErrorField]);\n      }\n\n      if (errorRange) {\n        this.addPointErrorBar(errorRange, point, field);\n      }\n    }\n  };\n\n  ScatterChart.prototype.addPointErrorBar = function addPointErrorBar(errorRange, point, field) {\n    var low = errorRange.low;\n    var high = errorRange.high;\n    var series = point.series;\n    var options = point.options.errorBars;\n    var isVertical = field === Y;\n    var item = {};\n    point[field + \"Low\"] = low;\n    point[field + \"High\"] = high;\n    point.errorBars = point.errorBars || [];\n    var errorBar = new ScatterErrorBar(low, high, isVertical, this, series, options);\n    point.errorBars.push(errorBar);\n    point.append(errorBar);\n    item[field] = low;\n    this.updateRange(item, series);\n    item[field] = high;\n    this.updateRange(item, series);\n  };\n\n  ScatterChart.prototype.addValue = function addValue(value, fields) {\n    var x = value.x;\n    var y = value.y;\n    var seriesIx = fields.seriesIx;\n    var series = this.options.series[seriesIx];\n    var missingValues = this.seriesMissingValues(series);\n    var seriesPoints = this.seriesPoints[seriesIx];\n    var pointValue = value;\n\n    if (!(hasValue(x) && hasValue(y))) {\n      pointValue = this.createMissingValue(pointValue, missingValues);\n    }\n\n    var point;\n\n    if (pointValue) {\n      point = this.createPoint(pointValue, fields);\n\n      if (point) {\n        Object.assign(point, fields);\n        this.addErrorBar(point, X, fields);\n        this.addErrorBar(point, Y, fields);\n      }\n\n      this.updateRange(pointValue, fields.series);\n    }\n\n    this.points.push(point);\n    seriesPoints.push(point);\n  };\n\n  ScatterChart.prototype.seriesMissingValues = function seriesMissingValues(series) {\n    return series.missingValues;\n  };\n\n  ScatterChart.prototype.createMissingValue = function createMissingValue() {};\n\n  ScatterChart.prototype.updateRange = function updateRange(value, series) {\n    var intlService = this.chartService.intl;\n    var xAxisName = series.xAxis;\n    var yAxisName = series.yAxis;\n    var x = value.x;\n    var y = value.y;\n    var xAxisRange = this.xAxisRanges[xAxisName];\n    var yAxisRange = this.yAxisRanges[yAxisName];\n\n    if (hasValue(x)) {\n      xAxisRange = this.xAxisRanges[xAxisName] = xAxisRange || {\n        min: MAX_VALUE,\n        max: MIN_VALUE\n      };\n\n      if (isString(x)) {\n        x = parseDate(intlService, x);\n      }\n\n      xAxisRange.min = Math.min(xAxisRange.min, x);\n      xAxisRange.max = Math.max(xAxisRange.max, x);\n    }\n\n    if (hasValue(y)) {\n      yAxisRange = this.yAxisRanges[yAxisName] = yAxisRange || {\n        min: MAX_VALUE,\n        max: MIN_VALUE\n      };\n\n      if (isString(y)) {\n        y = parseDate(intlService, y);\n      }\n\n      yAxisRange.min = Math.min(yAxisRange.min, y);\n      yAxisRange.max = Math.max(yAxisRange.max, y);\n    }\n  };\n\n  ScatterChart.prototype.evalPointOptions = function evalPointOptions(options, value, fields) {\n    var series = fields.series;\n    var seriesIx = fields.seriesIx;\n    var state = {\n      defaults: series._defaults,\n      excluded: [\"data\", \"tooltip\", \"content\", \"template\", \"visual\", \"toggle\", \"_outOfRangeMinPoint\", \"_outOfRangeMaxPoint\"]\n    };\n    var doEval = this._evalSeries[seriesIx];\n\n    if (!defined(doEval)) {\n      this._evalSeries[seriesIx] = doEval = evalOptions(options, {}, state, true);\n    }\n\n    var pointOptions = options;\n\n    if (doEval) {\n      pointOptions = deepExtend({}, options);\n      evalOptions(pointOptions, {\n        value: value,\n        series: series,\n        dataItem: fields.dataItem\n      }, state);\n    }\n\n    return pointOptions;\n  };\n\n  ScatterChart.prototype.pointType = function pointType() {\n    return LinePoint;\n  };\n\n  ScatterChart.prototype.pointOptions = function pointOptions(series, seriesIx) {\n    var options = this.seriesOptions[seriesIx];\n\n    if (!options) {\n      var defaults = this.pointType().prototype.defaults;\n      this.seriesOptions[seriesIx] = options = deepExtend({}, defaults, {\n        markers: {\n          opacity: series.opacity\n        },\n        tooltip: {\n          format: this.options.tooltip.format\n        },\n        labels: {\n          format: this.options.labels.format\n        }\n      }, series);\n    }\n\n    return options;\n  };\n\n  ScatterChart.prototype.createPoint = function createPoint(value, fields) {\n    var series = fields.series;\n    var pointOptions = this.pointOptions(series, fields.seriesIx);\n    var color = fields.color || series.color;\n    pointOptions = this.evalPointOptions(pointOptions, value, fields);\n\n    if (isFunction(series.color)) {\n      color = pointOptions.color;\n    }\n\n    var point = new LinePoint(value, pointOptions);\n    point.color = color;\n    this.append(point);\n    return point;\n  };\n\n  ScatterChart.prototype.seriesAxes = function seriesAxes(series) {\n    var xAxisName = series.xAxis;\n    var yAxisName = series.yAxis;\n    var plotArea = this.plotArea;\n    var xAxis = xAxisName ? plotArea.namedXAxes[xAxisName] : plotArea.axisX;\n    var yAxis = yAxisName ? plotArea.namedYAxes[yAxisName] : plotArea.axisY;\n\n    if (!xAxis) {\n      throw new Error(\"Unable to locate X axis with name \" + xAxisName);\n    }\n\n    if (!yAxis) {\n      throw new Error(\"Unable to locate Y axis with name \" + yAxisName);\n    }\n\n    return {\n      x: xAxis,\n      y: yAxis\n    };\n  };\n\n  ScatterChart.prototype.reflow = function reflow(targetBox) {\n    var this$1 = this;\n    var chartPoints = this.points;\n    var limit = !this.options.clip;\n    var pointIx = 0;\n    this.traverseDataPoints(function (value, fields) {\n      var point = chartPoints[pointIx++];\n      var seriesAxes = this$1.seriesAxes(fields.series);\n      var slotX = seriesAxes.x.getSlot(value.x, value.x, limit);\n      var slotY = seriesAxes.y.getSlot(value.y, value.y, limit);\n\n      if (point) {\n        if (slotX && slotY) {\n          var pointSlot = this$1.pointSlot(slotX, slotY);\n          point.reflow(pointSlot);\n        } else {\n          point.visible = false;\n        }\n      }\n    });\n    this.box = targetBox;\n  };\n\n  ScatterChart.prototype.pointSlot = function pointSlot(slotX, slotY) {\n    return new Box(slotX.x1, slotY.y1, slotX.x2, slotY.y2);\n  };\n\n  ScatterChart.prototype.traverseDataPoints = function traverseDataPoints(callback) {\n    var this$1 = this;\n    var ref = this;\n    var series = ref.options.series;\n    var seriesPoints = ref.seriesPoints;\n\n    for (var seriesIx = 0; seriesIx < series.length; seriesIx++) {\n      var currentSeries = series[seriesIx];\n      var currentSeriesPoints = seriesPoints[seriesIx];\n\n      if (!currentSeriesPoints) {\n        seriesPoints[seriesIx] = [];\n      }\n\n      for (var pointIx = 0; pointIx < currentSeries.data.length; pointIx++) {\n        var ref$1 = this$1._bindPoint(currentSeries, seriesIx, pointIx);\n\n        var value = ref$1.valueFields;\n        var fields = ref$1.fields;\n        callback(value, deepExtend({\n          pointIx: pointIx,\n          series: currentSeries,\n          seriesIx: seriesIx,\n          dataItem: currentSeries.data[pointIx],\n          owner: this$1\n        }, fields));\n      }\n    }\n  };\n\n  ScatterChart.prototype.formatPointValue = function formatPointValue(point, format) {\n    var value = point.value;\n    return this.chartService.format.auto(format, value.x, value.y);\n  };\n\n  ScatterChart.prototype.animationPoints = function animationPoints() {\n    var points = this.points;\n    var result = [];\n\n    for (var idx = 0; idx < points.length; idx++) {\n      result.push((points[idx] || {}).marker);\n    }\n\n    return result;\n  };\n\n  return ScatterChart;\n}(ChartElement);\n\nsetDefaultOptions(ScatterChart, {\n  series: [],\n  tooltip: {\n    format: \"{0}, {1}\"\n  },\n  labels: {\n    format: \"{0}, {1}\"\n  },\n  clip: true\n});\ndeepExtend(ScatterChart.prototype, ClipAnimationMixin, {\n  _bindPoint: CategoricalChart.prototype._bindPoint\n});\nexport default ScatterChart;","map":null,"metadata":{},"sourceType":"module"}